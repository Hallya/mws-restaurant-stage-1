/* global DBHelper */

var restaurant;
var map;

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').then(registration => {
      console.log('registration to serviceWorker complete with scope :', registration.scope);
    });
  });
}
/**
 * Initialize Google map, called from HTML.
 */
window.initMap = () => {
  fetchRestaurantFromURL().then(restaurant => {
    self.map = new google.maps.Map(document.getElementById('map'), {
      zoom: 16,
      center: restaurant.latlng,
      scrollwheel: false
    });
    DBHelper.mapMarkerForRestaurant(self.restaurant, self.map);
    fillBreadcrumb();
  });
};

/**
 * Get current restaurant from page URL.
 */
const fetchRestaurantFromURL = () => {
  if (self.restaurant) {
    // restaurant already fetched!
    return;
  }
  const id = getParameterByName('id');
  if (!id) {
    // no id found in URL
    return console.error('No restaurant id in URL');
  }
  return DBHelper.fetchRestaurantById(id).then(restaurant => self.restaurant = restaurant).then(fillRestaurantHTML).catch(error => console.error(error));
};

/**
 * Create restaurant HTML and add it to the webpage
 */
const fillRestaurantHTML = (restaurant = self.restaurant) => {
  const name = document.getElementById('restaurant-name');
  name.innerHTML = restaurant.name;

  const address = document.getElementById('restaurant-address');
  address.innerHTML = restaurant.address;
  address.setAttribute('aria-label', `located at ${restaurant.address}`);

  const source = document.getElementById('restaurant-source');
  const sourceWebp = document.getElementById('restaurant-sourceWebp');
  sourceWebp.srcset = `${DBHelper.imageWebpUrlForRestaurant(restaurant)}-large_x1.webp 1x, ${DBHelper.imageWebpUrlForRestaurant(restaurant)}-large_x2.webp 2x`;
  sourceWebp.media = '(min-width: 1000px)';
  source.srcset = `${DBHelper.imageUrlForRestaurant(restaurant)}-large_x1.jpg 1x, ${DBHelper.imageUrlForRestaurant(restaurant)}-large_x2.jpg 2x`;
  source.media = '(min-width: 1000px)';

  const ndSource = document.getElementById('restaurant-ndSource');
  const ndSourceWebp = document.getElementById('restaurant-ndSourceWebp');
  ndSourceWebp.srcset = `${DBHelper.imageWebpUrlForRestaurant(restaurant)}-medium_x1.webp 1x, ${DBHelper.imageWebpUrlForRestaurant(restaurant)}-medium_x2.jpg 2x`;
  ndSourceWebp.media = '(min-width: 420px)';
  ndSource.srcset = `${DBHelper.imageUrlForRestaurant(restaurant)}-medium_x1.jpg 1x, ${DBHelper.imageUrlForRestaurant(restaurant)}-medium_x2.jpg 2x`;
  ndSource.media = '(min-width: 420px)';

  const thSource = document.getElementById('restaurant-thSource');
  const thSourceWebp = document.getElementById('restaurant-thSourceWebp');
  thSourceWebp.srcset = `${DBHelper.imageWebpUrlForRestaurant(restaurant)}-small_x2.webp 2x, ${DBHelper.imageWebpUrlForRestaurant(restaurant)}-small_x1.jpg 1x`;
  thSourceWebp.media = '(min-width: 320px)';
  thSource.srcset = `${DBHelper.imageUrlForRestaurant(restaurant)}-small_x2.jpg 2x, ${DBHelper.imageUrlForRestaurant(restaurant)}-small_x1.jpg 1x`;
  thSource.media = '(min-width: 320px)';

  const image = document.getElementById('restaurant-img');
  image.className = 'restaurant-img';
  image.src = `${DBHelper.imageUrlForRestaurant(restaurant)}-large_x1.jpg`;
  image.setAttribute('sizes', '(max-width: 1100px) 85vw, (min-width: 1101px) 990px');
  image.alt = `${restaurant.name}'s  restaurant`;

  const cuisine = document.getElementById('restaurant-cuisine');
  cuisine.innerHTML = restaurant.cuisine_type;
  const labelFoodType = document.createElement('label');
  labelFoodType.innerHTML = `${restaurant.cuisine_type} food`;
  labelFoodType.setAttribute('hidden', 'hidden');
  labelFoodType.id = 'foodType';
  cuisine.parentNode.insertBefore(labelFoodType, cuisine.nextSibling);

  // fill operating hours
  if (restaurant.operating_hours) {
    fillRestaurantHoursHTML();
  }
  // fill reviews
  fillReviewsHTML();
  return restaurant;
};

/**
 * Create restaurant operating hours HTML table and add it to the webpage.
 */
const fillRestaurantHoursHTML = (operatingHours = self.restaurant.operating_hours) => {
  const hours = document.getElementById('restaurant-hours');
  for (let key in operatingHours) {
    const row = document.createElement('tr');

    const day = document.createElement('td');
    day.innerHTML = key;
    day.setAttribute('aria-label', `open on ${key}`);
    row.appendChild(day);

    const time = document.createElement('td');
    time.innerHTML = operatingHours[key];
    time.setAttribute('aria-label', `${operatingHours[key]},`);
    row.appendChild(time);
    row.setAttribute('role', 'row');
    hours.appendChild(row);
  }
};

/**
 * Create all reviews HTML and add them to the webpage.
 */
const fillReviewsHTML = (reviews = self.restaurant.reviews) => {
  const container = document.getElementById('reviews-container');
  const title = document.createElement('h3');
  title.innerHTML = 'Reviews';
  container.appendChild(title);

  if (!reviews) {
    const noReviews = document.createElement('p');
    noReviews.innerHTML = 'No reviews yet!';
    container.appendChild(noReviews);
    return;
  }
  const ul = document.getElementById('reviews-list');
  reviews.forEach(review => {
    ul.appendChild(createReviewHTML(review));
  });
  container.appendChild(ul);
};

/**
 * Create review HTML and add it to the webpage.
 */
const createReviewHTML = review => {
  const li = document.createElement('li');
  const name = document.createElement('p');
  name.className = 'userName';
  name.innerHTML = review.name;
  name.setAttribute('aria-label', `${review.name},`);
  li.appendChild(name);

  const date = document.createElement('p');
  date.className = 'dateReview';
  date.innerHTML = review.date;
  date.setAttribute('aria-label', `${review.date},`);
  li.appendChild(date);

  const rating = document.createElement('p');
  let stars = document.createElement('span');
  rating.className = 'userRating';
  stars.className = 'ratingStars';
  for (let i = 0; i < review.rating; i++) {
    stars.innerHTML += 'â˜…';
  }
  stars.setAttribute('aria-label', `${review.rating} stars on 5,`);
  rating.innerHTML = 'Rating: ';
  rating.appendChild(stars);
  li.appendChild(rating);

  const comments = document.createElement('p');
  comments.className = 'userComments';
  comments.innerHTML = review.comments;
  li.appendChild(comments);

  li.setAttribute('role', 'listitem');
  li.setAttribute('aria-setsize', self.restaurant.reviews.length);
  li.setAttribute('aria-posinset', self.restaurant.reviews.indexOf(review) + 1);
  return li;
};

/**
 * Add restaurant name to the breadcrumb navigation menu
 */
const fillBreadcrumb = (restaurant = self.restaurant) => {
  const breadcrumb = document.getElementById('breadcrumb');
  const li = document.createElement('li');
  li.innerHTML = ` ${restaurant.name}`;
  li.className = 'fontawesome-arrow-right';
  li.setAttribute('aria-current', 'page');
  breadcrumb.appendChild(li);
};

/**
 * Get a parameter by name from page URL.
 */
const getParameterByName = (name, url) => {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, '\\$&');
  const regex = new RegExp(`[?&]${name}(=([^&#]*)|&|#|$)`),
        results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, ' '));
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlc3RhdXJhbnRfaW5mby5qcyJdLCJuYW1lcyI6WyJyZXN0YXVyYW50IiwibWFwIiwibmF2aWdhdG9yIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsInNlcnZpY2VXb3JrZXIiLCJyZWdpc3RlciIsInRoZW4iLCJyZWdpc3RyYXRpb24iLCJjb25zb2xlIiwibG9nIiwic2NvcGUiLCJpbml0TWFwIiwiZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCIsInNlbGYiLCJnb29nbGUiLCJtYXBzIiwiTWFwIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsInpvb20iLCJjZW50ZXIiLCJsYXRsbmciLCJzY3JvbGx3aGVlbCIsIkRCSGVscGVyIiwibWFwTWFya2VyRm9yUmVzdGF1cmFudCIsImZpbGxCcmVhZGNydW1iIiwiaWQiLCJnZXRQYXJhbWV0ZXJCeU5hbWUiLCJlcnJvciIsImZldGNoUmVzdGF1cmFudEJ5SWQiLCJmaWxsUmVzdGF1cmFudEhUTUwiLCJjYXRjaCIsIm5hbWUiLCJpbm5lckhUTUwiLCJhZGRyZXNzIiwic2V0QXR0cmlidXRlIiwic291cmNlIiwic291cmNlV2VicCIsInNyY3NldCIsImltYWdlV2VicFVybEZvclJlc3RhdXJhbnQiLCJtZWRpYSIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsIm5kU291cmNlIiwibmRTb3VyY2VXZWJwIiwidGhTb3VyY2UiLCJ0aFNvdXJjZVdlYnAiLCJpbWFnZSIsImNsYXNzTmFtZSIsInNyYyIsImFsdCIsImN1aXNpbmUiLCJjdWlzaW5lX3R5cGUiLCJsYWJlbEZvb2RUeXBlIiwiY3JlYXRlRWxlbWVudCIsInBhcmVudE5vZGUiLCJpbnNlcnRCZWZvcmUiLCJuZXh0U2libGluZyIsIm9wZXJhdGluZ19ob3VycyIsImZpbGxSZXN0YXVyYW50SG91cnNIVE1MIiwiZmlsbFJldmlld3NIVE1MIiwib3BlcmF0aW5nSG91cnMiLCJob3VycyIsImtleSIsInJvdyIsImRheSIsImFwcGVuZENoaWxkIiwidGltZSIsInJldmlld3MiLCJjb250YWluZXIiLCJ0aXRsZSIsIm5vUmV2aWV3cyIsInVsIiwiZm9yRWFjaCIsInJldmlldyIsImNyZWF0ZVJldmlld0hUTUwiLCJsaSIsImRhdGUiLCJyYXRpbmciLCJzdGFycyIsImkiLCJjb21tZW50cyIsImxlbmd0aCIsImluZGV4T2YiLCJicmVhZGNydW1iIiwidXJsIiwibG9jYXRpb24iLCJocmVmIiwicmVwbGFjZSIsInJlZ2V4IiwiUmVnRXhwIiwicmVzdWx0cyIsImV4ZWMiLCJkZWNvZGVVUklDb21wb25lbnQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLFVBQUo7QUFDQSxJQUFJQyxHQUFKOztBQUVBLElBQUksbUJBQW1CQyxTQUF2QixFQUFrQztBQUNoQ0MsU0FBT0MsZ0JBQVAsQ0FBd0IsTUFBeEIsRUFBZ0MsTUFBTTtBQUNwQ0YsY0FBVUcsYUFBVixDQUF3QkMsUUFBeEIsQ0FBaUMsT0FBakMsRUFBMENDLElBQTFDLENBQStDQyxnQkFBZ0I7QUFDN0RDLGNBQVFDLEdBQVIsQ0FBWSxxREFBWixFQUFtRUYsYUFBYUcsS0FBaEY7QUFDRCxLQUZEO0FBR0QsR0FKRDtBQUtEO0FBQ0Q7OztBQUdBUixPQUFPUyxPQUFQLEdBQWlCLE1BQU07QUFDckJDLDJCQUNHTixJQURILENBQ1FQLGNBQWM7QUFDbEJjLFNBQUtiLEdBQUwsR0FBVyxJQUFJYyxPQUFPQyxJQUFQLENBQVlDLEdBQWhCLENBQW9CQyxTQUFTQyxjQUFULENBQXdCLEtBQXhCLENBQXBCLEVBQW9EO0FBQzdEQyxZQUFNLEVBRHVEO0FBRTdEQyxjQUFRckIsV0FBV3NCLE1BRjBDO0FBRzdEQyxtQkFBYTtBQUhnRCxLQUFwRCxDQUFYO0FBS0FDLGFBQVNDLHNCQUFULENBQWdDWCxLQUFLZCxVQUFyQyxFQUFpRGMsS0FBS2IsR0FBdEQ7QUFDQXlCO0FBQ0QsR0FUSDtBQVVELENBWEQ7O0FBYUE7OztBQUdBLE1BQU1iLHlCQUF5QixNQUFNO0FBQ25DLE1BQUlDLEtBQUtkLFVBQVQsRUFBcUI7QUFBRTtB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QUlDLE1BQUosQ0FBWSxPQUFNekQsSUFBSyxtQkFBdkIsQ0FBZDtBQUFBLFFBQ0UwRCxVQUFVRixNQUFNRyxJQUFOLENBQVdQLEdBQVgsQ0FEWjtBQUVBLE1BQUksQ0FBQ00sT0FBTCxFQUNFLE9BQU8sSUFBUDtBQUNGLE1BQUksQ0FBQ0EsUUFBUSxDQUFSLENBQUwsRUFDRSxPQUFPLEVBQVA7QUFDRixTQUFPRSxtQkFBbUJGLFFBQVEsQ0FBUixFQUFXSCxPQUFYLENBQW1CLEtBQW5CLEVBQTBCLEdBQTFCLENBQW5CLENBQVA7QUFDRCxDQVhEIiwiZmlsZSI6InJlc3RhdXJhbnRfaW5mby5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBEQkhlbHBlciAqL1xuXG52YXIgcmVzdGF1cmFudDtcbnZhciBtYXA7XG5cbmlmICgnc2VydmljZVdvcmtlcicgaW4gbmF2aWdhdG9yKSB7XG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xuICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKCdzdy5qcycpLnRoZW4ocmVnaXN0cmF0aW9uID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdyZWdpc3RyYXRpb24gdG8gc2VydmljZVdvcmtlciBjb21wbGV0ZSB3aXRoIHNjb3BlIDonLCByZWdpc3RyYXRpb24uc2NvcGUpO1xuICAgIH0pO1xuICB9KTtcbn1cbi8qKlxuICogSW5pdGlhbGl6ZSBHb29nbGUgbWFwLCBjYWxsZWQgZnJvbSBIVE1MLlxuICovXG53aW5kb3cuaW5pdE1hcCA9ICgpID0+IHtcbiAgZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCgpXG4gICAgLnRoZW4ocmVzdGF1cmFudCA9PiB7XG4gICAgICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XG4gICAgICAgIHpvb206IDE2LFxuICAgICAgICBjZW50ZXI6IHJlc3RhdXJhbnQubGF0bG5nLFxuICAgICAgICBzY3JvbGx3aGVlbDogZmFsc2VcbiAgICAgIH0pO1xuICAgICAgREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQsIHNlbGYubWFwKTtcbiAgICAgIGZpbGxCcmVhZGNydW1iKCk7XG4gICAgfSk7XG59O1xuXG4vKipcbiAqIEdldCBjdXJyZW50IHJlc3RhdXJhbnQgZnJvbSBwYWdlIFVSTC5cbiAqL1xuY29uc3QgZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCA9ICgpID0+IHtcbiAgaWYgKHNlbGYucmVzdGF1cmFudCkgeyAvLyByZXN0YXVyYW50IGFscmVhZHkgZmV0Y2hlZCFcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgaWQgPSBnZXRQYXJhbWV0ZXJCeU5hbWUoJ2lkJyk7XG4gIGlmICghaWQpIHsgLy8gbm8gaWQgZm91bmQgaW4gVVJMXG4gICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoJ05vIHJlc3RhdXJhbnQgaWQgaW4gVVJMJyk7XG4gIH1cbiAgcmV0dXJuIERCSGVscGVyLmZldGNoUmVzdGF1cmFudEJ5SWQoaWQpXG4gICAgLnRoZW4ocmVzdGF1cmFudCA9PiBzZWxmLnJlc3RhdXJhbnQgPSByZXN0YXVyYW50KVxuICAgIC50aGVuKGZpbGxSZXN0YXVyYW50SFRNTClcbiAgICAuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5lcnJvcihlcnJvcikpO1xufTtcblxuLyoqXG4gKiBDcmVhdGUgcmVzdGF1cmFudCBIVE1MIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2VcbiAqL1xuY29uc3QgZmlsbFJlc3RhdXJhbnRIVE1MID0gKHJlc3RhdXJhbnQgPSBzZWxmLnJlc3RhdXJhbnQpID0+IHtcbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LW5hbWUnKTtcbiAgbmFtZS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XG5cbiAgY29uc3QgYWRkcmVzcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWFkZHJlc3MnKTtcbiAgYWRkcmVzcy5pbm5lckhUTUwgPSByZXN0YXVyYW50LmFkZHJlc3M7XG4gIGFkZHJlc3Muc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYGxvY2F0ZWQgYXQgJHtyZXN0YXVyYW50LmFkZHJlc3N9YCk7XG5cbiAgY29uc3Qgc291cmNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtc291cmNlJyk7XG4gIGNvbnN0IHNvdXJjZVdlYnAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1zb3VyY2VXZWJwJyk7XG4gIHNvdXJjZVdlYnAuc3Jjc2V0ID0gYCR7REJIZWxwZXIuaW1hZ2VXZWJwVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tbGFyZ2VfeDEud2VicCAxeCwgJHtEQkhlbHBlci5pbWFnZVdlYnBVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpfS1sYXJnZV94Mi53ZWJwIDJ4YDtcbiAgc291cmNlV2VicC5tZWRpYSA9ICcobWluLXdpZHRoOiAxMDAwcHgpJztcbiAgc291cmNlLnNyY3NldCA9IGAke0RCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tbGFyZ2VfeDEuanBnIDF4LCAke0RCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tbGFyZ2VfeDIuanBnIDJ4YDtcbiAgc291cmNlLm1lZGlhID0gJyhtaW4td2lkdGg6IDEwMDBweCknO1xuXG4gIGNvbnN0IG5kU291cmNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtbmRTb3VyY2UnKTtcbiAgY29uc3QgbmRTb3VyY2VXZWJwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtbmRTb3VyY2VXZWJwJyk7XG4gIG5kU291cmNlV2VicC5zcmNzZXQgPSBgJHtEQkhlbHBlci5pbWFnZVdlYnBVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpfS1tZWRpdW1feDEud2VicCAxeCwgJHtEQkhlbHBlci5pbWFnZVdlYnBVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpfS1tZWRpdW1feDIuanBnIDJ4YDtcbiAgbmRTb3VyY2VXZWJwLm1lZGlhID0gJyhtaW4td2lkdGg6IDQyMHB4KSc7XG4gIG5kU291cmNlLnNyY3NldCA9IGAke0RCSGVscGVyLmltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KX0tbWVkaXVtX3gxLmpwZyAxeCwgJHtEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCl9LW1lZGl1bV94Mi5qcGcgMnhgO1xuICBuZFNvdXJjZS5tZWRpYSA9ICcobWluLXdpZHRoOiA0MjBweCknO1xuXG4gIGNvbnN0IHRoU291cmNlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtdGhTb3VyY2UnKTtcbiAgY29uc3QgdGhTb3VyY2VXZWJwID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtdGhTb3VyY2VXZWJwJyk7XG4gIHRoU291cmNlV2VicC5zcmNzZXQgPSBgJHtEQkhlbHBlci5pbWFnZVdlYnBVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpfS1zbWFsbF94Mi53ZWJwIDJ4LCAke0RCSGVscGVyLmltYWdlV2VicFVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCl9LXNtYWxsX3gxLmpwZyAxeGA7XG4gIHRoU291cmNlV2VicC5tZWRpYSA9ICcobWluLXdpZHRoOiAzMjBweCknO1xuICB0aFNvdXJjZS5zcmNzZXQgPSBgJHtEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCl9LXNtYWxsX3gyLmpwZyAyeCwgJHtEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCl9LXNtYWxsX3gxLmpwZyAxeGA7XG4gIHRoU291cmNlLm1lZGlhID0gJyhtaW4td2lkdGg6IDMyMHB4KSc7XG5cbiAgY29uc3QgaW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1pbWcnKTtcbiAgaW1hZ2UuY2xhc3NOYW1lID0gJ3Jlc3RhdXJhbnQtaW1nJztcbiAgaW1hZ2Uuc3JjID0gYCR7REJIZWxwZXIuaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpfS1sYXJnZV94MS5qcGdgO1xuICBpbWFnZS5zZXRBdHRyaWJ1dGUoJ3NpemVzJywgJyhtYXgtd2lkdGg6IDExMDBweCkgODV2dywgKG1pbi13aWR0aDogMTEwMXB4KSA5OTBweCcpO1xuICBpbWFnZS5hbHQgPSBgJHtyZXN0YXVyYW50Lm5hbWV9J3MgIHJlc3RhdXJhbnRgO1xuXG4gIGNvbnN0IGN1aXNpbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1jdWlzaW5lJyk7XG4gIGN1aXNpbmUuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5jdWlzaW5lX3R5cGU7XG4gIGNvbnN0IGxhYmVsRm9vZFR5cGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpO1xuICBsYWJlbEZvb2RUeXBlLmlubmVySFRNTCA9IGAke3Jlc3RhdXJhbnQuY3Vpc2luZV90eXBlfSBmb29kYDtcbiAgbGFiZWxGb29kVHlwZS5zZXRBdHRyaWJ1dGUoJ2hpZGRlbicsICdoaWRkZW4nKTtcbiAgbGFiZWxGb29kVHlwZS5pZCA9ICdmb29kVHlwZSc7XG4gIGN1aXNpbmUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobGFiZWxGb29kVHlwZSwgY3Vpc2luZS5uZXh0U2libGluZyk7XG5cbiAgLy8gZmlsbCBvcGVyYXRpbmcgaG91cnNcbiAgaWYgKHJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzKSB7XG4gICAgZmlsbFJlc3RhdXJhbnRIb3Vyc0hUTUwoKTtcbiAgfVxuICAvLyBmaWxsIHJldmlld3NcbiAgZmlsbFJldmlld3NIVE1MKCk7XG4gIHJldHVybiByZXN0YXVyYW50O1xufTtcblxuLyoqXG4gKiBDcmVhdGUgcmVzdGF1cmFudCBvcGVyYXRpbmcgaG91cnMgSFRNTCB0YWJsZSBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxuICovXG5jb25zdCBmaWxsUmVzdGF1cmFudEhvdXJzSFRNTCA9IChvcGVyYXRpbmdIb3VycyA9IHNlbGYucmVzdGF1cmFudC5vcGVyYXRpbmdfaG91cnMpID0+IHtcbiAgY29uc3QgaG91cnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1ob3VycycpO1xuICBmb3IgKGxldCBrZXkgaW4gb3BlcmF0aW5nSG91cnMpIHtcbiAgICBjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpO1xuXG4gICAgY29uc3QgZGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcbiAgICBkYXkuaW5uZXJIVE1MID0ga2V5O1xuICAgIGRheS5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBgb3BlbiBvbiAke2tleX1gKTtcbiAgICByb3cuYXBwZW5kQ2hpbGQoZGF5KTtcblxuICAgIGNvbnN0IHRpbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpO1xuICAgIHRpbWUuaW5uZXJIVE1MID0gb3BlcmF0aW5nSG91cnNba2V5XTtcbiAgICB0aW1lLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsIGAke29wZXJhdGluZ0hvdXJzW2tleV19LGApO1xuICAgIHJvdy5hcHBlbmRDaGlsZCh0aW1lKTtcbiAgICByb3cuc2V0QXR0cmlidXRlKCdyb2xlJywgJ3JvdycpO1xuICAgIGhvdXJzLmFwcGVuZENoaWxkKHJvdyk7XG4gIH1cbn07XG5cblxuLyoqXG4gKiBDcmVhdGUgYWxsIHJldmlld3MgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmNvbnN0IGZpbGxSZXZpZXdzSFRNTCA9IChyZXZpZXdzID0gc2VsZi5yZXN0YXVyYW50LnJldmlld3MpID0+IHtcbiAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtY29udGFpbmVyJyk7XG4gIGNvbnN0IHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDMnKTtcbiAgdGl0bGUuaW5uZXJIVE1MID0gJ1Jldmlld3MnO1xuICBjb250YWluZXIuYXBwZW5kQ2hpbGQodGl0bGUpO1xuXG4gIGlmICghcmV2aWV3cykge1xuICAgIGNvbnN0IG5vUmV2aWV3cyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICBub1Jldmlld3MuaW5uZXJIVE1MID0gJ05vIHJldmlld3MgeWV0ISc7XG4gICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG5vUmV2aWV3cyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jldmlld3MtbGlzdCcpO1xuICByZXZpZXdzLmZvckVhY2gocmV2aWV3ID0+IHtcbiAgICB1bC5hcHBlbmRDaGlsZChjcmVhdGVSZXZpZXdIVE1MKHJldmlldykpO1xuICB9KTtcbiAgY29udGFpbmVyLmFwcGVuZENoaWxkKHVsKTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIHJldmlldyBIVE1MIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmNvbnN0IGNyZWF0ZVJldmlld0hUTUwgPSAocmV2aWV3KSA9PiB7XG4gIGNvbnN0IGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgY29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgbmFtZS5jbGFzc05hbWUgPSAndXNlck5hbWUnO1xuICBuYW1lLmlubmVySFRNTCA9IHJldmlldy5uYW1lO1xuICBuYW1lLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbCcsIGAke3Jldmlldy5uYW1lfSxgKTtcbiAgbGkuYXBwZW5kQ2hpbGQobmFtZSk7XG5cbiAgY29uc3QgZGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgZGF0ZS5jbGFzc05hbWUgPSAnZGF0ZVJldmlldyc7XG4gIGRhdGUuaW5uZXJIVE1MID0gcmV2aWV3LmRhdGU7XG4gIGRhdGUuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYCR7cmV2aWV3LmRhdGV9LGApO1xuICBsaS5hcHBlbmRDaGlsZChkYXRlKTtcblxuICBjb25zdCByYXRpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIGxldCBzdGFycyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgcmF0aW5nLmNsYXNzTmFtZSA9ICd1c2VyUmF0aW5nJztcbiAgc3RhcnMuY2xhc3NOYW1lID0gJ3JhdGluZ1N0YXJzJztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXZpZXcucmF0aW5nOyBpKyspIHtcbiAgICBzdGFycy5pbm5lckhUTUwgKz0gJ+KYhSc7XG4gIH1cbiAgc3RhcnMuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYCR7cmV2aWV3LnJhdGluZ30gc3RhcnMgb24gNSxgKTtcbiAgcmF0aW5nLmlubmVySFRNTCA9ICdSYXRpbmc6ICc7XG4gIHJhdGluZy5hcHBlbmRDaGlsZChzdGFycyk7XG4gIGxpLmFwcGVuZENoaWxkKHJhdGluZyk7XG5cbiAgY29uc3QgY29tbWVudHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIGNvbW1lbnRzLmNsYXNzTmFtZSA9ICd1c2VyQ29tbWVudHMnO1xuICBjb21tZW50cy5pbm5lckhUTUwgPSByZXZpZXcuY29tbWVudHM7XG4gIGxpLmFwcGVuZENoaWxkKGNvbW1lbnRzKTtcblxuICBsaS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCAnbGlzdGl0ZW0nKTtcbiAgbGkuc2V0QXR0cmlidXRlKCdhcmlhLXNldHNpemUnLCBzZWxmLnJlc3RhdXJhbnQucmV2aWV3cy5sZW5ndGgpO1xuICBsaS5zZXRBdHRyaWJ1dGUoJ2FyaWEtcG9zaW5zZXQnLCBzZWxmLnJlc3RhdXJhbnQucmV2aWV3cy5pbmRleE9mKHJldmlldykrMSk7XG4gIHJldHVybiBsaTtcbn07XG5cbi8qKlxuICogQWRkIHJlc3RhdXJhbnQgbmFtZSB0byB0aGUgYnJlYWRjcnVtYiBuYXZpZ2F0aW9uIG1lbnVcbiAqL1xuY29uc3QgZmlsbEJyZWFkY3J1bWIgPSAocmVzdGF1cmFudCA9IHNlbGYucmVzdGF1cmFudCkgPT4ge1xuICBjb25zdCBicmVhZGNydW1iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyZWFkY3J1bWInKTtcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICBsaS5pbm5lckhUTUwgPSBgICR7cmVzdGF1cmFudC5uYW1lfWA7XG4gIGxpLmNsYXNzTmFtZSA9ICdmb250YXdlc29tZS1hcnJvdy1yaWdodCc7XG4gIGxpLnNldEF0dHJpYnV0ZSgnYXJpYS1jdXJyZW50JywgJ3BhZ2UnKTtcbiAgYnJlYWRjcnVtYi5hcHBlbmRDaGlsZChsaSk7XG59O1xuXG4vKipcbiAqIEdldCBhIHBhcmFtZXRlciBieSBuYW1lIGZyb20gcGFnZSBVUkwuXG4gKi9cbmNvbnN0IGdldFBhcmFtZXRlckJ5TmFtZSA9IChuYW1lLCB1cmwpID0+IHtcbiAgaWYgKCF1cmwpXG4gICAgdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7XG4gIG5hbWUgPSBuYW1lLnJlcGxhY2UoL1tcXFtcXF1dL2csICdcXFxcJCYnKTtcbiAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbPyZdJHtuYW1lfSg9KFteJiNdKil8JnwjfCQpYCksXG4gICAgcmVzdWx0cyA9IHJlZ2V4LmV4ZWModXJsKTtcbiAgaWYgKCFyZXN1bHRzKVxuICAgIHJldHVybiBudWxsO1xuICBpZiAoIXJlc3VsdHNbMl0pXG4gICAgcmV0dXJuICcnO1xuICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHJlc3VsdHNbMl0ucmVwbGFjZSgvXFwrL2csICcgJykpO1xufTsiXX0=
