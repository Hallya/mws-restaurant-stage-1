let restaurants,neighborhoods,cuisines,cuisine,neighborhood,loading=!1,markers=[];const mainContent=document.querySelector("main"),footer=document.querySelector("footer"),filterOptions=document.querySelector(".filter-options"),filterResultHeading=document.querySelector(".filter-options h3"),filterButton=document.querySelector("#menuFilter"),listOfRestaurants=document.querySelector("#restaurants-list"),sectionMap=document.getElementById("#map-container"),neighborhoodsSelect=document.querySelector("#neighborhoods-select"),cuisinesSelect=document.querySelector("#cuisines-select"),mapDiv=document.querySelector("#map"),loader=document.querySelector("#map-loader");function openMenu(){filterOptions.classList.remove("optionsClose"),mainContent.classList.remove("moveUp"),footer.classList.remove("moveUp"),filterOptions.classList.add("optionsOpen"),filterOptions.setAttribute("aria-hidden","false"),mainContent.classList.add("moveDown"),footer.classList.add("moveDown"),filterButton.classList.add("pressed"),filterButton.blur(),filterResultHeading.setAttribute("tabindex","-1"),filterResultHeading.focus()}function closeMenu(){filterOptions.classList.remove("optionsOpen"),filterOptions.classList.add("optionsClose"),filterOptions.setAttribute("aria-hidden","true"),filterButton.classList.remove("pressed"),mainContent.classList.remove("moveDown"),mainContent.classList.add("moveUp"),footer.classList.remove("moveDown"),footer.classList.add("moveUp"),filterResultHeading.removeAttribute("tabindex")}document.addEventListener("DOMContentLoaded",()=>{window.navigator.standalone||-1!==window.navigator.userAgent.indexOf("Android")||-1!==window.navigator.userAgent.indexOf("Linux")||addBannerToHomeScreen(),cuisinesSelect.addEventListener("change",updateRestaurants),neighborhoodsSelect.addEventListener("change",updateRestaurants),fetchNeighborhoods().then(fetchCuisines).then(updateRestaurants).catch(e=>console.error(e))}),filterButton.addEventListener("click",()=>{filterOptions.classList.contains("optionsClose")?openMenu():closeMenu()}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{const e="hallya.github.io"===window.location.hostname?"/mws-restaurant-stage-1/sw.js":"../sw.js";navigator.serviceWorker.register(e).then(e=>console.log("registration to serviceWorker complete with scope :",e.scope))}),document.onkeypress=function(e){13===e.charCode&&filterOptions.classList.contains("optionsOpen")&&(closeMenu(),listOfRestaurants.setAttribute("tabindex","0"),listOfRestaurants.focus())};const fetchNeighborhoods=()=>DBHelper.fetchNeighborhoods().then(e=>{self.neighborhoods=e,fillNeighborhoodsHTML()}).catch(e=>console.error(e)),fillNeighborhoodsHTML=(e=self.neighborhoods)=>{const t=neighborhoodsSelect;e.forEach(r=>{const n=document.createElement("option");n.innerHTML=r,n.value=r,n.setAttribute("role","option"),n.setAttribute("aria-setsize","4"),n.setAttribute("aria-posinset",e.indexOf(r)+2),t.append(n)})},fetchCuisines=()=>{DBHelper.fetchCuisines().then(e=>{self.cuisines=e,fillCuisinesHTML()}).catch(e=>console.error(e))},fillCuisinesHTML=(e=self.cuisines)=>{const t=cuisinesSelect;e.forEach(r=>{const n=document.createElement("option");n.innerHTML=r,n.value=r,n.setAttribute("role","option"),n.setAttribute("aria-setsize","4"),n.setAttribute("aria-posinset",e.indexOf(r)+2),t.append(n)})};window.initMap=(()=>{const e=document.createElement("div");e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true"),e.id="map";self.map=new google.maps.Map(e,{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),document.getElementById("map-container").appendChild(e),self.map.addListener("tilesloaded",function(){loader.remove(),updateRestaurants().then(addMarkersToMap)})});const updateRestaurants=()=>{const e=cuisinesSelect,t=neighborhoodsSelect,r=e.selectedIndex,n=t.selectedIndex;return cuisine===e[r].value&&neighborhood===t[n].value?(console.log("- Restaurants list already update"),Promise.resolve()):(cuisine=e[r].value,neighborhood=t[n].value,DBHelper.fetchRestaurantByCuisineAndNeighborhood(cuisine,neighborhood).then(resetRestaurants).then(fillRestaurantsHTML).then(launch.lazyLoading).then(()=>console.log("- Restaurants list updated !")).catch(e=>console.error(e)))},resetRestaurants=e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",markers.length>0&&self.markers.forEach(e=>e.setMap(null)),self.markers=[],self.restaurants=e},fillRestaurantsHTML=(e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))})},getAverageNote=e=>{let t=0;return e.forEach(e=>{t+=Number(e.rating)}),t/=e.length,Math.round(10*t)/10},createRestaurantHTML=e=>{const t=document.createElement("li"),r=document.createElement("figure"),n=document.createElement("figcaption"),s=document.createElement("picture"),o=document.createElement("source"),a=document.createElement("source"),i=document.createElement("source"),c=document.createElement("source"),l=document.createElement("source"),u=document.createElement("source"),d=document.createElement("img"),p=document.createElement("aside"),m=document.createElement("p");c.dataset.srcset=`${DBHelper.imageWebpUrlForRestaurant(e)}-large_x1.webp 1x, ${DBHelper.imageWebpUrlForRestaurant(e)}-large_x2.webp 2x`,c.srcset="assets/img/svg/puff.svg",c.media="(min-width: 1000px)",c.className="lazy",c.type="image/webp",o.dataset.srcset=`${DBHelper.imageUrlForRestaurant(e)}-large_x1.jpg 1x, ${DBHelper.imageUrlForRestaurant(e)}-large_x2.jpg 2x`,o.srcset="assets/img/svg/puff.svg",o.media="(min-width: 1000px)",o.className="lazy",o.type="image/jpeg",l.dataset.srcset=`${DBHelper.imageWebpUrlForRestaurant(e)}-medium_x1.webp 1x, ${DBHelper.imageWebpUrlForRestaurant(e)}-medium_x2.webp 2x`,l.srcset="assets/img/svg/puff.svg",l.media="(min-width: 420px)",l.className="lazy",l.type="image/webp",a.dataset.srcset=`${DBHelper.imageUrlForRestaurant(e)}-medium_x1.jpg 1x, ${DBHelper.imageUrlForRestaurant(e)}-medium_x2.jpg 2x`,a.srcset="assets/img/svg/puff.svg",a.media="(min-width: 420px)",a.className="lazy",a.type="image/jpeg",u.dataset.srcset=`${DBHelper.imageWebpUrlForRestaurant(e)}-small_x2.webp 2x, ${DBHelper.imageWebpUrlForRestaurant(e)}-small_x1.webp 1x`,u.srcset="assets/img/svg/puff.svg",u.media="(min-width: 320px)",u.className="lazy",u.type="image/webp",i.dataset.srcset=`${DBHelper.imageUrlForRestaurant(e)}-small_x2.jpg 2x, ${DBHelper.imageUrlForRestaurant(e)}-small_x1.jpg 1x`,i.srcset="assets/img/svg/puff.svg",i.media="(min-width: 320px)",i.className="lazy",i.type="image/jpeg",d.dataset.src=`${DBHelper.imageUrlForRestaurant(e)}-small_x1.jpg`,d.src="assets/img/svg/puff.svg",d.className="restaurant-img lazy",d.setAttribute("sizes","(max-width: 1100px) 85vw, (min-width: 1101px) 990px"),d.alt=`${e.name}'s restaurant`,d.type="image/jpeg",m.innerHTML=`${getAverageNote(e.reviews)}/5`,p.append(m),s.append(c),s.append(o),s.append(l),s.append(a),s.append(u),s.append(i),s.append(d),r.append(s),r.append(n),t.append(p),t.append(r);const h=document.createElement("h2");h.innerHTML=e.name,n.append(h);const f=document.createElement("p");f.innerHTML=e.neighborhood,t.append(f);const g=document.createElement("p");g.innerHTML=e.address,t.append(g);const y=document.createElement("a");return y.innerHTML="View Details",y.href=DBHelper.urlForRestaurant(e),y.setAttribute("aria-label",`View details of ${e.name}`),y.setAttribute("rel","noopener"),t.append(y),t.setAttribute("role","listitem"),t.setAttribute("aria-setsize","10"),t.setAttribute("aria-posinset",e.id),t},addMarkersToMap=(e=self.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),self.markers.push(t)})},addBannerToHomeScreen=()=>{const e=document.createElement("aside"),t=document.createElement("p"),r=document.createElement("p"),n=document.createElement("span");e.id="pop",e.className="popup",r.className="popup msg",r.setAttribute("tabindex","2"),t.className="popup note",t.setAttribute("tabindex","1"),n.className="iconicfill-arrow-down",t.innerHTML="(Tap to close)",r.innerHTML='Add <img src="assets/img/svg/share-apple.svg" alt=""> this app to your home screen and enjoy it as a real application !',e.setAttribute("tabindex","-1"),e.addEventListener("click",()=>{e.classList.add("hide"),setTimeout(()=>{e.style="display: none;"},1e3)}),e.append(t),e.append(r),e.append(n),document.getElementById("maincontent").appendChild(e),e.focus(),setTimeout(()=>{e.classList.add("hide")},7e3)};class DBHelper{static get DATABASE_URL(){return window.navigator.standalone?"data/restaurants.json":"http://localhost:1337/restaurants"}static fetchRestaurants(){return idbKey.getAll("restaurants").then(e=>e.length<10?(console.log(`Path to data: ${DBHelper.DATABASE_URL}`),fetch(DBHelper.DATABASE_URL).then(e=>e.json()).then(e=>(console.log("- Restaurants data fetched !"),e.restaurants||e)).then(e=>e.forEach(e=>idbKey.set("restaurants",e)),e).catch(e=>console.error(`Request failed. Returned status of ${e}`))):e).catch(e=>{console.error(e)})}static fetchRestaurantById(e){return idbKey.get("restaurants",Number(e)).then(t=>t||(console.log("- No cache found"),fetch(DBHelper.DATABASE_URL).then(e=>e.json()).then(t=>{const r=t[e-1];return idbKey.set("restaurants",r),r}).catch(e=>console.error(`Restaurant does not exist: ${e}`))))}static fetchRestaurantByCuisine(e){return DBHelper.fetchRestaurants().then(t=>t.restaurants.filter(t=>t.cuisine_type==e)).catch(e=>console.error(e))}static fetchRestaurantByNeighborhood(e){return DBHelper.fetchRestaurants().then(t=>t.restaurants.filter(t=>t.neighborhood==e)).catch(e=>console.error(e))}static fetchRestaurantByCuisineAndNeighborhood(e,t){return idbKey.getAll("restaurants").then(r=>r.length<10?DBHelper.fetchRestaurants().then(r=>{const n=r;return n.forEach(e=>idbKey.set("restaurants",e)),DBHelper.filterResults(n,e,t)}).catch(e=>console.error(e)):DBHelper.filterResults(r,e,t)).catch(e=>console.error(e))}static filterResults(e,t,r){return"all"!==t&&(e=e.filter(e=>e.cuisine_type==t)),"all"!==r&&(e=e.filter(e=>e.neighborhood==r)),e}static fetchNeighborhoods(){return DBHelper.fetchRestaurants().then(e=>{const t=e.map(e=>e.neighborhood);return t.filter((e,r)=>t.indexOf(e)==r)}).catch(e=>console.error(e))}static fetchCuisines(){return DBHelper.fetchRestaurants().then(e=>{const t=e.map(e=>e.cuisine_type);return t.filter((e,r)=>t.indexOf(e)==r)}).catch(e=>console.error(e))}static urlForRestaurant(e){return`restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`assets/img/jpg/${e.photograph}`}static imageWebpUrlForRestaurant(e){return`assets/img/webp/${e.photograph}`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}const launch={lazyLoading:()=>{var e=[].slice.call(document.querySelectorAll(".lazy"));if("IntersectionObserver"in window){let t=new IntersectionObserver(function(e,r){e.forEach(function(e){if(e.isIntersecting){let r=e.target;"source"===r.localName?r.srcset=r.dataset.srcset:r.src=r.dataset.src,r.classList.remove("lazy"),t.unobserve(r)}})});e.forEach(function(e){t.observe(e)})}else{let e=[].slice.call(document.querySelectorAll(".lazy")),t=!1;const r=function(){!1===t&&(t=!0,setTimeout(function(){e.forEach(function(t){t.getBoundingClientRect().top<=window.innerHeight+50&&t.getBoundingClientRect().bottom>=0&&"none"!==getComputedStyle(t).display&&(t.src=t.dataset.src,t.srcset=t.dataset.srcset,t.classList.remove("lazy"),0===(e=e.filter(function(e){return e!==t})).length&&(document.removeEventListener("scroll",r),window.removeEventListener("resize",r),window.removeEventListener("orientationchange",r)))}),t=!1},200))};document.addEventListener("scroll",r),window.addEventListener("resize",r),window.addEventListener("orientationchange",r),document.onreadystatechange=function(){"complete"==document.readyState&&r()}}},switchLoaderToMap:()=>{document.getElementById("map").classList.contains("hidden")&&(document.getElementById("map").classList.remove("hidden"),document.getElementById("map-loader").classList.add("hidden"))}},openDatabase=()=>{if(navigator.serviceWorker)return idb.open("restaurant-reviews",1,e=>{switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"})}})},idbKey={get:(e,t)=>openDatabase().then(r=>{if(r)return r.transaction(e).objectStore(e).get(t)}).catch(e=>console.error(e)),set:(e,t)=>openDatabase().then(r=>{if(!r)return;return r.transaction(e,"readwrite").objectStore(e).put(t).complete}).catch(e=>console.error(e)),getAll:e=>openDatabase().then(t=>{if(t)return t.transaction(e).objectStore(e).getAll()}).catch(e=>console.error(e))};function toArray(e){return Array.prototype.slice.call(e)}function promisifyRequest(e){return new Promise(function(t,r){e.onsuccess=function(){t(e.result)},e.onerror=function(){r(e.error)}})}function promisifyRequestCall(e,t,r){var n,s=new Promise(function(s,o){promisifyRequest(n=e[t].apply(e,r)).then(s,o)});return s.request=n,s}function promisifyCursorRequestCall(e,t,r){var n=promisifyRequestCall(e,t,r);return n.then(function(e){if(e)return new Cursor(e,n.request)})}function proxyProperties(e,t,r){r.forEach(function(r){Object.defineProperty(e.prototype,r,{get:function(){return this[t][r]},set:function(e){this[t][r]=e}})})}function proxyRequestMethods(e,t,r,n){n.forEach(function(n){n in r.prototype&&(e.prototype[n]=function(){return promisifyRequestCall(this[t],n,arguments)})})}function proxyMethods(e,t,r,n){n.forEach(function(n){n in r.prototype&&(e.prototype[n]=function(){return this[t][n].apply(this[t],arguments)})})}function proxyCursorRequestMethods(e,t,r,n){n.forEach(function(n){n in r.prototype&&(e.prototype[n]=function(){return promisifyCursorRequestCall(this[t],n,arguments)})})}function Index(e){this._index=e}function Cursor(e,t){this._cursor=e,this._request=t}function ObjectStore(e){this._store=e}function Transaction(e){this._tx=e,this.complete=new Promise(function(t,r){e.oncomplete=function(){t()},e.onerror=function(){r(e.error)},e.onabort=function(){r(e.error)}})}function UpgradeDB(e,t,r){this._db=e,this.oldVersion=t,this.transaction=new Transaction(r)}function DB(e){this._db=e}proxyProperties(Index,"_index",["name","keyPath","multiEntry","unique"]),proxyRequestMethods(Index,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),proxyCursorRequestMethods(Index,"_index",IDBIndex,["openCursor","openKeyCursor"]),proxyProperties(Cursor,"_cursor",["direction","key","primaryKey","value"]),proxyRequestMethods(Cursor,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(Cursor.prototype[e]=function(){var t=this,r=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,r),promisifyRequest(t._request).then(function(e){if(e)return new Cursor(e,t._request)})})})}),ObjectStore.prototype.createIndex=function(){return new Index(this._store.createIndex.apply(this._store,arguments))},ObjectStore.prototype.index=function(){return new Index(this._store.index.apply(this._store,arguments))},proxyProperties(ObjectStore,"_store",["name","keyPath","indexNames","autoIncrement"]),proxyRequestMethods(ObjectStore,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),proxyCursorRequestMethods(ObjectStore,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),proxyMethods(ObjectStore,"_store",IDBObjectStore,["deleteIndex"]),Transaction.prototype.objectStore=function(){return new ObjectStore(this._tx.objectStore.apply(this._tx,arguments))},proxyProperties(Transaction,"_tx",["objectStoreNames","mode"]),proxyMethods(Transaction,"_tx",IDBTransaction,["abort"]),UpgradeDB.prototype.createObjectStore=function(){return new ObjectStore(this._db.createObjectStore.apply(this._db,arguments))},proxyProperties(UpgradeDB,"_db",["name","version","objectStoreNames"]),proxyMethods(UpgradeDB,"_db",IDBDatabase,["deleteObjectStore","close"]),DB.prototype.transaction=function(){return new Transaction(this._db.transaction.apply(this._db,arguments))},proxyProperties(DB,"_db",["name","version","objectStoreNames"]),proxyMethods(DB,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[ObjectStore,Index].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t=toArray(arguments),r=t[t.length-1],n=this._store||this._index,s=n[e].apply(n,t.slice(0,-1));s.onsuccess=function(){r(s.result)}}})}),[Index,ObjectStore].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var r=this,n=[];return new Promise(function(s){r.iterateCursor(e,function(e){e?(n.push(e.value),void 0===t||n.length!=t?e.continue():s(n)):s(n)})})})});var exp={open:function(e,t,r){var n=promisifyRequestCall(indexedDB,"open",[e,t]),s=n.request;return s.onupgradeneeded=function(e){r&&r(new UpgradeDB(s.result,e.oldVersion,s.transaction))},n.then(function(e){return new DB(e)})},delete:function(e){return promisifyRequestCall(indexedDB,"deleteDatabase",[e])}};self.idb=exp;