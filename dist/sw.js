!function(){return function e(t,n,r){function s(a,i){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!i&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){return s(t[a][1][e]||e)},l,l.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)s(r[a]);return s}}()({1:[function(e,t,n){const r=e("./indexedb"),s="/restaurants/",o="/reviews/",a="/?is_favorite=",i="?restaurant_id=",c="http://localhost:3000",u={DATABASE_URL:{GET:{allRestaurants:()=>fetch(c+s),allReviews:()=>fetch(c+o),restaurant:e=>fetch(c+s+e),restaurantReviews:e=>fetch(c+o+i+e)},POST:{newReview:e=>fetch(c+o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},PUT:{favoriteRestaurant:(e,t)=>fetch(c+s+e+a+t,{method:"PUT"}),updateReview:e=>fetch(c+o+e,{method:"PUT"})},DELETE:{review:e=>fetch(c+o+e,{method:"DELETE"})}},fetchRestaurants:async()=>{const e=await r.getAll("restaurants").catch(e=>console.error(e));if(e.length<10){const e=await u.DATABASE_URL.GET.allRestaurants(),t=e&&await e.json();return console.log("- Restaurants data fetched"),t.forEach(e=>{e.is_favorite=e.is_favorite&&e.is_favorite.toString(),r.set("restaurants",e)}),t}return e},fetchReviews:async()=>{const e=await u.DATABASE_URL.GET.allReviews().catch(e=>console.error(`Request failed. Returned status of ${e}`)),t=await e&&e.json();return console.log("- Reviews data fetched !"),t},fetchRestaurantReviews:async e=>{let t=await r.getAll("reviews").catch(e=>console.error(e));if((t=t.filter(t=>t.restaurant_id===Number(e))).length)return t;{const t=await u.DATABASE_URL.GET.restaurantReviews(e).catch(e=>console.error(`Request failed. Returned status of ${e}`));let n=await t&&t.json();return console.log("- Restaurant reviews fetched !"),await n&&n.length&&n.forEach(e=>r.set("reviews",e)),n}},fetchRestaurantById:async e=>{const t=await r.get("restaurants",Number(e));if(t)return t;{console.log("- No restaurant cached");const t=await u.DATABASE_URL.GET.restaurant(e).catch(e=>console.error(`Restaurant does not exist: ${e}`)),n=t&&await t.json();return n.is_favorite=n.is_favorite.toString(),r.set("restaurants",n),n}},fetchRestaurantByCuisineAndNeighborhood:async(e,t)=>{const n=await r.getAll("restaurants").catch(e=>console.error(e));if(n.length<10){const n=await u.fetchRestaurants().catch(e=>console.error(e));return n.forEach(e=>r.set("restaurants",e)),u.filterResults(n,e,t)}return u.filterResults(n,e,t)},filterResults:(e,t,n)=>("all"!==t&&(e=e.filter(e=>e.cuisine_type==t)),"all"!==n&&(e=e.filter(e=>e.neighborhood==n)),e),addNeighborhoodsOptions:e=>{const t=e.map(e=>e.neighborhood);return t.filter((e,n)=>t.indexOf(e)==n)},addCuisinesOptions:e=>{const t=e.map(e=>e.cuisine_type);return t.filter((e,n)=>t.indexOf(e)==n)},urlForRestaurant:e=>`restaurant.html?id=${e.id}`,imageUrlForRestaurant:e=>`assets/img/jpg/${e.photograph}`,imageWebpUrlForRestaurant:e=>`assets/img/webp/${e.photograph}`,postReview:async e=>{e.preventDefault();const t=document.querySelector("#title-container form").elements,n={restaurant_id:Number(window.location.search.match(/\d+/)[0]),name:t.name.value,rating:Number(t.rating.value),comments:t.comments.value};await r.set("posts",n),n.createdAt=Date.now(),n.updatedAt=Date.now(),await r.addReview("reviews",n),console.log(navigator.serviceWorker.ready);const s=await navigator.serviceWorker.ready;await s.sync.register({id:"post-review"}),location.reload()},setFavorite:async(e,t,n,s)=>{e.classList.toggle("hidden");const o="true"===t.is_favorite?"false":"true";return n.setAttribute("aria-label",e.classList.contains("hidden")?`unset ${t.name} as favorite`:`set ${t.name} as favorite`),e.setAttribute("aria-hidden","true"===t.is_favorite?"true":"false"),s.setAttribute("aria-hidden","true"===t.is_favorite?"false":"true"),t.is_favorite=o,await r.set("restaurants",t),await u.DATABASE_URL.PUT.favoriteRestaurant(t.id,o)},mapMarkerForRestaurant:(e,t)=>{return new google.maps.Marker({position:{lat:e.lat||e.latlng.lat,lng:e.lng||e.latlng.lng},title:e.name,url:u.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP,icon:"assets/img/svg/marker.svg"})}};t.exports=u},{"./indexedb":2}],2:[function(e,t,n){const r=e("../../node_modules/idb/lib/idb"),s=()=>r.open("restaurant-reviews",3,e=>{switch(e.oldVersion){case 0:e.createObjectStore("restaurants",{keyPath:"id"});case 1:e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0});case 1:e.createObjectStore("posts",{keyPath:"restaurant_id"})}}),o={async get(e,t){const n=await s().catch(e=>console.error(e));if(n)return n.transaction(e).objectStore(e).get(t)},async set(e,t){const n=await s().catch(e=>console.error(e));if(n)return(await n.transaction(e,"readwrite").objectStore(e).put(t)).complete},async getAll(e){const t=await s().catch(e=>console.error(e));if(t)return t.transaction(e).objectStore(e).getAll()},async delete(e,t){const n=await s().catch(e=>console.error(e));if(n)return n.transaction(e,"readwrite").objectStore(e).delete(t)},async addReview(e,t){const n=await s().catch(e=>console.error(e));if(n)return n.transaction(e,"readwrite").objectStore(e).add(t)},async getRestaurantReviews(e,t){const n=await s().catch(e=>console.error(e));if(n)return(await n.transaction(e).objectStore(e).getAll()).filter(e=>e.restaurant_id===t)}};t.exports=o},{"../../node_modules/idb/lib/idb":4}],3:[function(e,t,n){(function(t){const n="object"==typeof self&&self.self===self&&self||"object"==typeof t&&t.global===t&&t||this,r=e("./js/indexedb"),s=e("./js/dbhelper"),o={CACHE_STATIC:"static-cache-3",CACHE_MAP:"map-api-3",CACHE_FONT:"google-fonts-3"},a=["/","manifest.webmanifest","index.html","restaurant.html","sw.js","js/main.js","js/restaurant_info.js","assets/css/index.css","assets/css/restaurant_info.css","assets/css/fonts/iconicfill.woff2","assets/css/fonts/fontawesome.woff2","assets/img/svg/puff.svg","assets/img/svg/map-loader.svg","assets/img/svg/marker.svg","assets/img/svg/no-wifi.svg","assets/img/svg/favorite.svg","assets/img/svg/not-favorite.svg","assets/img/png/logo-64.png","assets/img/png/logo-128.png","assets/img/png/logo-256.png","assets/img/png/logo-512.png","assets/img/png/launchScreen-ipad-9.7.png","assets/img/png/launchScreen-ipadpro-10.5.png","assets/img/png/launchScreen-ipadpro-12.9.png","assets/img/png/launchScreen-iphone-8.png","assets/img/png/launchScreen-iphone-8plus.png","assets/img/png/launchScreen-iphone-x.png","assets/img/png/launchScreen-iphone-se.png"];async function i(e,t){const n=await caches.open(e),r=await n.match(t);if(r)return r;const s=await fetch(t).catch(e=>(async function(e,t){if(console.error("ERROR handled by SW:",e),t.url.match(/undefined/)&&"image"===t.format&&console.log(url),t.url.match(/\.(jpe?g|webp)$/i))return(await caches.open(o.CACHE_STATIC)).match("assets/img/svg/no-wifi.svg");if(t.url.match(/reviews\/\?restaurant_id=$/))return console.log("couocu")})(e,t));return s.url.match(/no-wifi.svg$/)||n.put(t,s.clone()),s}self.addEventListener("install",e=>{console.log(`SW - Cache version : "${o.CACHE_STATIC}"`),e.waitUntil(caches.open(o.CACHE_STATIC).then(e=>e.addAll(a)).then(()=>(console.log("SW - All resources cached."),console.log("SW - SW version skipped."),self.skipWaiting())).catch(e=>console.error("SW - Open cache failed :",e)))}),self.addEventListener("activate",e=>{const t=Object.keys(o).map(e=>o[e]);e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(-1==t.indexOf(e))return console.log("SW - Deleting",e),caches.delete(e)}))).then(()=>(console.log(`SW - "${o.CACHE_STATIC}" now ready to handle fetches!`),self.clients.claim())))}),self.addEventListener("fetch",e=>{const t=new URL(e.request.url),r=n.location;switch(t.hostname){case"maps.gstatic.com":e.respondWith(i(o.CACHE_MAP,e.request));break;case"fonts.gstatic.com":e.respondWith(i(o.CACHE_FONT,e.request));break;case r.hostname:if(t.pathname.startsWith("/restaurant.html")){const n=t.href.replace(/[?&]id=\d{1,}/,"");e.respondWith(i(o.CACHE_STATIC,n))}else t.pathname.startsWith("/restaurants")||t.pathname.startsWith("/reviews")||"GET"!==e.request.method?e.respondWith(fetch(e.request)):e.respondWith(i(o.CACHE_STATIC,e.request));break;default:e.respondWith(fetch(e.request))}});self.addEventListener("sync",function(e){console.log("sync event triggered"),"post-review"===e.tag&&e.waitUntil(async function e(t=0){const n=await r.getAll("posts").catch(e=>console.error(e));return console.log("postLocalReviews triggered"),await Promise.all(n.map(async n=>{const o=await s.DATABASE_URL.POST.newReview(n).catch(n=>(0===t&&self.registration.showNotification("Your review will be posted later"),console.error("Review not posted",n),setTimeout(()=>e(1),1e4),null));return console.log("Response after post request",o,"\nStatus :",o.status),o&&201===o.status?(await self.registration.showNotification("Review synchronised to server"),await r.delete("posts",n.restaurant_id)):o}))}()),e.lastChance&&console.log("Last time trying to sync"),"fetch-new-reviews"===e.tag&&e.waitUntil((async()=>{const e=(await self.clients.matchAll()).replace(n.location.host,"").match(/\d+/)[0],t=await s.DATABASE_URL.GET.restaurantReviews(e),o=await t.json();o.forEach(e=>r.set("reviews",e))})())})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./js/dbhelper":1,"./js/indexedb":2}],4:[function(e,t,n){"use strict";!function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function n(t,n,r){var s,o=new Promise(function(o,a){e(s=t[n].apply(t,r)).then(o,a)});return o.request=s,o}function r(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function s(e,t,r,s){s.forEach(function(s){s in r.prototype&&(e.prototype[s]=function(){return n(this[t],s,arguments)})})}function o(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function a(e,t,r,s){s.forEach(function(s){s in r.prototype&&(e.prototype[s]=function(){return e=this[t],(r=n(e,s,arguments)).then(function(e){if(e)return new c(e,r.request)});var e,r})})}function i(e){this._index=e}function c(e,t){this._cursor=e,this._request=t}function u(e){this._store=e}function l(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function f(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new l(n)}function d(e){this._db=e}r(i,"_index",["name","keyPath","multiEntry","unique"]),s(i,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),a(i,"_index",IDBIndex,["openCursor","openKeyCursor"]),r(c,"_cursor",["direction","key","primaryKey","value"]),s(c,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(c.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new c(e,n._request)})})})}),u.prototype.createIndex=function(){return new i(this._store.createIndex.apply(this._store,arguments))},u.prototype.index=function(){return new i(this._store.index.apply(this._store,arguments))},r(u,"_store",["name","keyPath","indexNames","autoIncrement"]),s(u,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),a(u,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(u,"_store",IDBObjectStore,["deleteIndex"]),l.prototype.objectStore=function(){return new u(this._tx.objectStore.apply(this._tx,arguments))},r(l,"_tx",["objectStoreNames","mode"]),o(l,"_tx",IDBTransaction,["abort"]),f.prototype.createObjectStore=function(){return new u(this._db.createObjectStore.apply(this._db,arguments))},r(f,"_db",["name","version","objectStoreNames"]),o(f,"_db",IDBDatabase,["deleteObjectStore","close"]),d.prototype.transaction=function(){return new l(this._db.transaction.apply(this._db,arguments))},r(d,"_db",["name","version","objectStoreNames"]),o(d,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[u,i].forEach(function(t){e in t.prototype&&(t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],s=this._store||this._index,o=s[e].apply(s,n.slice(0,-1));o.onsuccess=function(){r(o.result)}})})}),[i,u].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(s){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():s(r)):s(r)})})})});var p={open:function(e,t,r){var s=n(indexedDB,"open",[e,t]),o=s.request;return o&&(o.onupgradeneeded=function(e){r&&r(new f(o.result,e.oldVersion,o.transaction))}),s.then(function(e){return new d(e)})},delete:function(e){return n(indexedDB,"deleteDatabase",[e])}};void 0!==t?(t.exports=p,t.exports.default=t.exports):self.idb=p}()},{}]},{},[3]);